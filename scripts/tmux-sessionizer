#!/usr/bin/env bash

# Inspired by The Primeagen's tmux-sessionizer
# https://github.com/ThePrimeagen/.dotfiles/blob/master/bin/.local/scripts/tmux-sessionizer

CREATE_NEW_VALUE='Create New Session'
session_list=$(tmux list-sessions)
session_list+="\n$CREATE_NEW_VALUE"

FIND_ROOT=~/Documents

if [[ $# > 0 ]]; then
	selected_session="$1"
	command="$2"
else
	selected_name=$(
		echo -e "$session_list" |
			fzf --reverse |
			sed '/^$/d' |
			cut -d':' -f1
	)

	if [[ $selected_name != $CREATE_NEW_VALUE ]]; then
		tmux-attach "$selected_name"
		exit 0
	fi

	selected_session=$(realpath "$(find "$FIND_ROOT" -maxdepth 4 -type d | fzf --reverse)")
fi

echo $selected_session

if [[ -z $selected_session ]]; then
	>&2 echo "E: Could not resolve session"
	exit 1
fi

selected_name=$(basename "$selected_session" | tr . _)

if ! tmux has-session -t="$selected_name" 2>/dev/null; then
	# Create new detached tmux session
	>&2 echo "Creating new session $selected_name"
	tmux new-session -ds "$selected_name" -c "$selected_session" $command
fi

tmux-attach "$selected_name"
